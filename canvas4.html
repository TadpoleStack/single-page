<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>canvas画扇形图</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      html,
      body,
      #app {
        width: 100%;
        height: 100%;
      }
      #box {
        margin: 100px;
        width: 40%;
        height: 50%;
        border: 1px solid rgba(0, 0, 0, 0.3);
      }
    </style>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/lib/theme-chalk/index.css"
    />
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.0.2/vue.global.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vuex/4.0.0-rc.1/vuex.global.js"></script>
    <script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
<script id="template" type="x-template">
    <!-- 更新：<el-switch v-model="type" @change="change"/> -->
  <div id="box"></div>
</script>
<script>
  const {
    createApp,
    defineComponent,
    reactive,
    toRefs,
    onMounted,
    computed,
  } = Vue;
  const App = defineComponent({
    name: "App",
    template: "#template",
    setup() {
      const state = reactive({
        data: null,
        type: true,
        update: null,
      });
      const change = (params) => {
        if (params) {
          state.update({
            data: state.data,
            axis: {
              y: [-12, 12],
              x: [0, 1, 2, 3, 3.5],
            },
          });
        } else {
          state.update({
            data: [
              [
                [-5, -2],
                [-3, 11],
                [0, 0],
                [1, 11],
                [4, -1],
              ],
            ],
            axis: {
              y: [-2, 12],
              x: [-5, 5],
            },
          });
        }
      };
      const canvasStart = (config) => {
        //获取DOM对象属性
        const getStyle = (obj, att) =>
          obj.currentStyle
            ? obj.currentStyle[att]
            : window.getComputedStyle(obj, false)[att];
        let box = document.querySelector(config.selector);
        let canvas = document.createElement("canvas");
        box.appendChild(canvas);
        let width = 0; //画布宽
        let height = 0; //画布高
        let ctx = canvas.getContext("2d");
        let data = [];
        let originPoint = [0, 0]; //圆心
        let radius = 1; //半径
        let sum = 1;
        //初始化
        const init = () => {
          //设置canvas宽高与box相等
          width = Number(getStyle(box, "width").replace("px", ""));
          height = Number(getStyle(box, "height").replace("px", ""));
          canvas.width = width;
          canvas.height = height;
          data = config.data;
          originPoint = [width / 2, height / 2];
          radius = Math.min(width, height)/2 * 0.8;
        };
        //计算
        const computed = () => {
          sum = 0;
          for (let i = 0, Len = data.length; i < Len; i++) sum += data[i].value;
        };
        //画图
        const draw = async () => {
            let angleCount = 0//角度累计
            for(let i=0,Len=data.length;i<Len;i++){
                let angleStart = 0,angleEnd=0;
                if(i==0){
                    angleStart = 0
                    angleEnd = data[i].value*Math.PI*2/sum
                    angleCount += angleEnd
                }else{
                    angleStart = angleCount
                    angleEnd = angleStart + data[i].value*Math.PI*2/sum
                    angleCount += data[i].value*Math.PI*2/sum
                }
                ctx.beginPath();
                // if(i==0){
                //     ctx.moveTo(...originPoint)
                //     ctx.lineTo(originPoint[0]+radius,originPoint[1])
                // }
                ctx.arc(...originPoint,radius,angleStart,angleEnd,false);
                ctx.lineTo(...originPoint);
                ctx.strokeStyle = data[i].color;
                ctx.stroke();
                ctx.fillStyle = data[i].color;
                ctx.fill();
            }
        }
        init();
        computed();
        draw();
        return {
            update:function(updateConfig){
                config = Object.assign(config, updateConfig);
                ctx.clearRect(0, 0, width, height);
                init();
                computed();
                draw();
            },
            resize:function(){
                ctx.clearRect(0, 0, width, height);
                init();
                computed();
                draw();
            },
            ctx:ctx
        }
      };
      onMounted(() => {
        let data = [
          { value: 1, text: "项目一",color:'red' },
          { value: 2, text: "项目二",color:'skyblue' },
          { value: 6, text: "项目三",color:'orange' },
        ];
        canvasStart({
          selector: "#box",
          data: data,
        });
      });
      return {
        ...toRefs(state),
        change,
      };
    },
  });
  const app = createApp(App);
  app.use(ElementPlus).mount("#app");
</script>
